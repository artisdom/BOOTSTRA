IF %MODE%==CLEAN GOTO :EOF

IF x%2==xWORD GOTO :MRM16
IF x%2==xBYTE GOTO :MRM8
CALL ISREG16 %2
IF %RESULT%==1 SHIFTOP %1 WORD %2 %3 %4 %5 %6 %7 %8 %9
CALL ISREG8 %2
IF %RESULT%==1 SHIFTOP %1 BYTE %2 %3 %4 %5 %6 %7 %8 %9
ECHO Expected byte or word ModR/M (IP=%IP%)

:MRM16
CALL CMRM16 %3
IF %DISPBYTES%==0 GOTO :MRM216
GOTO :MRM316

:MRM8
CALL CMRM8 %3
IF %DISPBYTES%==0 GOTO :MRM28
GOTO :MRM38

:MRM216
IF x%4==x GOTO :MRM16ONE
IF x%4==xCL GOTO :MRM16CL

CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 193
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
CALL EMITBYTE %4

GOTO :EOF

:MRM316
IF x%5==x GOTO :MRM16ONE
IF x%5==xCL GOTO :MRM16CL

CALL RPN! _%IP%_3+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK1
CALL IS8SIGN %4
IF %RESULT%==1 GOTO :NOCHECK1
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK1
CALL EMITBYTE 193
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %4
IF %DISPBYTES%==2 CALL EMITWORD %4
CALL EMITBYTE %5

GOTO :EOF

:MRM28
IF x%4==x GOTO :MRM8ONE
IF x%4==xCL GOTO :MRM8CL

CALL RPN! _%IP%_3+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL EMITBYTE 192
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
CALL EMITBYTE %4

GOTO :EOF

:MRM38
IF x%5==x GOTO :MRM8ONE
IF x%5==xCL GOTO :MRM8CL

CALL RPN! _%IP%_3+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK2
CALL IS8SIGN %4
IF %RESULT%==1 GOTO :NOCHECK2
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK2
CALL EMITBYTE 192
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %4
IF %DISPBYTES%==2 CALL EMITWORD %4
CALL EMITBYTE %5

GOTO :EOF

:MRM16ONE
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK3
CALL IS8SIGN %4
IF %RESULT%==1 GOTO :NOCHECK3
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK3
CALL EMITBYTE 209
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %4
IF %DISPBYTES%==2 CALL EMITWORD %4

GOTO :EOF

:MRM8ONE
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK4
CALL IS8SIGN %4
IF %RESULT%==1 GOTO :NOCHECK4
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK4
CALL EMITBYTE 208
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %4
IF %DISPBYTES%==2 CALL EMITWORD %4

GOTO :EOF

:MRM16CL
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK5
CALL IS8SIGN %4
IF %RESULT%==1 GOTO :NOCHECK5
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK5
CALL EMITBYTE 211
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %4
IF %DISPBYTES%==2 CALL EMITWORD %4

GOTO :EOF

:MRM8CL
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK6
CALL IS8SIGN %4
IF %RESULT%==1 GOTO :NOCHECK6
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK6
CALL EMITBYTE 210
CALL RPN! _%MRM%_%1_8*+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %4
IF %DISPBYTES%==2 CALL EMITWORD %4

:EOF
