IF %MODE%==CLEAN GOTO :EOF

IF x%1==xBYTE GOTO :XMRM8
IF x%1==xWORD GOTO :XMRM16
CALL ISREG8 %1
IF %RESULT%==1 GOTO :MRM8
CALL ISREG16 %1
IF %RESULT%==1 GOTO :MRM16
ECHO Expected byte or word ModR/M (IP=%IP%)

:XMRM16
SHIFT
:MRM16
CALL CMRM16 %1
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK1
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECK1
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK1
CALL EMITBYTE 247
CALL RPN! _%MRM%_40+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
GOTO :EOF

:XMRM8
SHIFT
:MRM8
CALL CMRM8 %1
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK2
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECK2
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK2
CALL EMITBYTE 246
CALL RPN! _%MRM%_40+
CALL EMITBYTE %RESULT%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2
GOTO :EOF

:EOF
