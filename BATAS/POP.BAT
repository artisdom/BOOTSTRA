IF %MODE%==CLEAN GOTO :EOF

CALL ISREGSEG %1
IF %RESULT%==1 GOTO :REGSEG
CALL ISREG16 %1
IF %RESULT%==1 GOTO :REG16
CALL ISMRM16 %1
IF %RESULT%==1 GOTO :MRM16
ECHO Expected register, segment register, or ModR/M (IP=%IP%)

:REG16
CALL RPN! _%IP%_1+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL CREG16 %1
CALL RPN! _88_%REG%+
CALL EMITBYTE %RESULT%
GOTO :EOF

:REGSEG
CALL RPN! _%IP%_1+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
CALL CREGSEG %1
CALL RPN! _%REG%_8*_7+
CALL EMITBYTE %RESULT%
GOTO :EOF

:MRM16
CALL CMRM16 %1
CALL RPN! _%IP%_2+_%DISPBYTES%+
SET IP=%RESULT%
IF %MODE%==COUNT GOTO :EOF
IF NOT %DISPBYTES%==1 GOTO :NOCHECK
CALL IS8SIGN %2
IF %RESULT%==1 GOTO :NOCHECK
ECHO Byte displacement truncated (IP=%IP%)
:NOCHECK
CALL EMITBYTE 143
CALL EMITBYTE %MRM%
IF %DISPBYTES%==1 CALL EMITBYTE %2
IF %DISPBYTES%==2 CALL EMITWORD %2

:EOF
